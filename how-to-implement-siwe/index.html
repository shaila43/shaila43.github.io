<!DOCTYPE html><html  lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><script type="importmap">{"imports":{"#entry":"/_nuxt/B5M63L3k.js"}}</script><title>Thoughts, Sparks &amp; Chaos - Programming &amp; Beyond</title><link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"><style>.page-enter-active,.page-leave-active{transition:all .4s}.page-enter-from,.page-leave-to{filter:blur(1rem);opacity:0}</style><link rel="stylesheet" href="/_nuxt/entry.CVLDiw7e.css" crossorigin><link rel="preload" as="fetch" crossorigin="anonymous" href="/how-to-implement-siwe/_payload.json?0fc9bcfb-d588-4046-8f0a-fcc4ef694756"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/B5M63L3k.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/C-Tg5-9s.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ChXfpoHm.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/Bqydwg0p.js"><link rel="preload" as="fetch" fetchpriority="low" crossorigin="anonymous" href="/_nuxt/builds/meta/0fc9bcfb-d588-4046-8f0a-fcc4ef694756.json"><link rel="prefetch" as="script" crossorigin href="/_nuxt/DawHPHLe.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/qXAomcMk.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/DxqlPeTn.js"><meta name="author" content="Shaila43"><meta name="description" content="Notes, experiments and fragments of programming knowledge, mixed with random sparks of curiosity."><meta name="keywords" content="programming, code, software, web development, notes, experiments, knowledge"><meta property="og:title" content="Thoughts, Sparks & Chaos - Programming & Beyond"><meta property="og:description" content="Notes, experiments and fragments of programming knowledge, mixed with random sparks of curiosity."><meta property="og:type" content="website"><script type="module" src="/_nuxt/B5M63L3k.js" crossorigin></script><script id="unhead:payload" type="application/json">{"title":"Thoughts, Sparks & Chaos - Programming & Beyond"}</script></head><body><div id="__nuxt"><div class="max-w-7xl mx-auto p-4"><div><article class="max-w-3xl mx-auto"><img src="/img/how-to-implement-siwe.webp" class="w-full aspect-16/9 mx-auto"><h2 class="text-2xl md:text-3xl lg:text-4xl my-5 md:my-8 lg:my-10 font-bold text-neutral-800"> How to implement SIWE | EIP-4361 </h2><div class="space-y-4 md:space-y-6"><p class="text-lg/relaxed text-neutral-700"><a class="link-primary" href="https://eips.ethereum.org/EIPS/eip-4361" target="_blank" rel="noopener noreferrer">EIP-4361</a>: Sign-In With Ethereum (SIWE) allows users to authenticate by proving ownership of their Ethereum account. Instead of traditional logins or passwords, users sign a message with their wallet, like MetaMask. <br></p><p class="text-lg/relaxed text-neutral-700"> The SIWE message can be generated either on the frontend or backend. In our setup, itâ€™s created on the frontend, and then sent to the backend for verification. The backend (Laravel in our case) verifies the cryptographic signature to confirm that the message was signed by the correct Ethereum address and generates a Sanctum token for the user. This token is then used to authenticate the user in subsequent requests, providing a secure, passwordless login experience. </p><p class="text-lg/relaxed text-neutral-700">Why Use SIWE:</p><ul class="text-lg/relaxed text-neutral-700 list-disc ml-10 space-y-3 marker:text-gray-300"><li>Passwordless authentication</li><li>Decentralized identity</li><li>Strong cryptographic security</li></ul><p class="text-lg/relaxed text-neutral-700"> Install the <a href="https://www.npmjs.com/package/siwe" rel="noopener noreferrer" target="_blank" class="link-primary">siwe</a> and <a href="https://www.npmjs.com/package/ethers" rel="noopener noreferrer" target="_blank" class="link-primary">ethers</a> package on the frontend. </p><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#A6E22E">npm</span><span style="color:#E6DB74"> i</span><span style="color:#E6DB74"> siwe</span></span>
<span class="line"><span style="color:#A6E22E">npm</span><span style="color:#E6DB74"> i</span><span style="color:#E6DB74"> ethers</span></span></code></pre></div></div><p class="text-lg/relaxed text-neutral-700"> Create Sign in with Metamask button and add click event on it. </p><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">&#x3C;</span><span style="color:#F92672">template</span><span style="color:#F8F8F2">></span></span>
<span class="line"><span style="color:#F8F8F2">  &#x3C;</span><span style="color:#F92672">button</span><span style="color:#F8F8F2"> @</span><span style="color:#A6E22E">click</span><span style="color:#F8F8F2">=</span><span style="color:#F8F8F2">"</span><span style="color:#F8F8F2">onSignInWithMetamask</span><span style="color:#F8F8F2">"</span><span style="color:#F8F8F2">></span></span>
<span class="line"><span style="color:#F8F8F2">    Sign in with Metamask</span></span>
<span class="line"><span style="color:#F8F8F2">  &#x3C;/</span><span style="color:#F92672">button</span><span style="color:#F8F8F2">></span></span>
<span class="line"><span style="color:#F8F8F2">&#x3C;/</span><span style="color:#F92672">template</span><span style="color:#F8F8F2">></span></span></code></pre></div></div><p class="text-lg/relaxed text-neutral-700"> In Laravel project install required <a href="https://packagist.org/packages/digitaldonkey/ecverify" rel="noopener noreferrer" target="_blank" class="link-primary">digitaldonkey/ecverify</a> package. </p><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#A6E22E">composer</span><span style="color:#E6DB74"> require</span><span style="color:#E6DB74"> digitaldonkey/ecverify</span></span></code></pre></div></div><p class="text-lg/relaxed text-neutral-700"> Create wallet address field in users table and wallet address field to fillable array in User model. </p><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#A6E22E">php</span><span style="color:#E6DB74"> artisan</span><span style="color:#E6DB74"> make:migration</span><span style="color:#E6DB74"> add_wallet_address_to_users_table</span></span></code></pre></div></div><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#88846F">// migration file</span></span>
<span class="line"><span style="color:#F8F8F2">$table</span><span style="color:#F92672">-></span><span style="color:#A6E22E">string</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'wallet_address'</span><span style="color:#F8F8F2">)</span><span style="color:#F92672">-></span><span style="color:#A6E22E">unique</span><span style="color:#F8F8F2">()</span><span style="color:#F92672">-></span><span style="color:#A6E22E">nullable</span><span style="color:#F8F8F2">();</span></span></code></pre></div></div><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#88846F">// User.php</span></span>
<span class="line"><span style="color:#F92672">protected</span><span style="color:#F8F8F2"> $fillable </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> [</span></span>
<span class="line"><span style="color:#88846F">  // current fields...,</span></span>
<span class="line"><span style="color:#E6DB74">  'wallet_address'</span></span>
<span class="line"><span style="color:#F8F8F2">];</span></span></code></pre></div></div><p class="text-lg/relaxed text-neutral-700"> Create Siwe model, migration and controller. </p><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#A6E22E">php</span><span style="color:#E6DB74"> artisan</span><span style="color:#E6DB74"> make:model</span><span style="color:#E6DB74"> Siwe</span><span style="color:#AE81FF"> -mvc</span></span></code></pre></div></div><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#88846F">// migration file</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">Schema</span><span style="color:#F92672">::</span><span style="color:#A6E22E">create</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'siwes'</span><span style="color:#F8F8F2">, </span><span style="color:#66D9EF;font-style:italic">function</span><span style="color:#F8F8F2"> (</span><span style="color:#66D9EF;font-style:italic">Blueprint</span><span style="color:#F8F8F2"> $table) {</span></span>
<span class="line"><span style="color:#F8F8F2">    $table</span><span style="color:#F92672">-></span><span style="color:#A6E22E">id</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">    $table</span><span style="color:#F92672">-></span><span style="color:#A6E22E">string</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'nonce'</span><span style="color:#F8F8F2">)</span><span style="color:#F92672">-></span><span style="color:#A6E22E">unique</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">    $table</span><span style="color:#F92672">-></span><span style="color:#A6E22E">timestamp</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'expires_at'</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    $table</span><span style="color:#F92672">-></span><span style="color:#A6E22E">timestamps</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">});</span></span></code></pre></div></div><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#88846F">// Siwe.php    </span></span>
<span class="line"><span style="color:#F92672">protected</span><span style="color:#F8F8F2"> $fillable </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> [</span></span>
<span class="line"><span style="color:#E6DB74">  'nonce'</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#E6DB74">  'expires_at'</span></span>
<span class="line"><span style="color:#F8F8F2">];</span></span></code></pre></div></div><p class="text-lg/relaxed text-neutral-700"> Prepare endpoints for nonce and verify. </p><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#88846F">// api.php</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">Route</span><span style="color:#F92672">::</span><span style="color:#A6E22E">prefix</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'auth/siwe'</span><span style="color:#F8F8F2">)</span><span style="color:#F92672">-></span><span style="color:#A6E22E">group</span><span style="color:#F8F8F2">(</span><span style="color:#66D9EF;font-style:italic">function</span><span style="color:#F8F8F2"> () {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    Route</span><span style="color:#F92672">::</span><span style="color:#A6E22E">get</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'/nonce'</span><span style="color:#F8F8F2">, [</span><span style="color:#66D9EF;font-style:italic">SiweController</span><span style="color:#F92672">::class</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'nonce'</span><span style="color:#F8F8F2">]);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    Route</span><span style="color:#F92672">::</span><span style="color:#A6E22E">post</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'/verify'</span><span style="color:#F8F8F2">, [</span><span style="color:#66D9EF;font-style:italic">SiweController</span><span style="color:#F92672">::class</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'verify'</span><span style="color:#F8F8F2">]);</span></span>
<span class="line"><span style="color:#F8F8F2">});</span></span></code></pre></div></div><p class="text-lg/relaxed text-neutral-700"> Create controller with required methods. </p><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#F92672">&#x3C;?</span><span style="color:#AE81FF">php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">namespace</span><span> </span><span style="color:#A6E22E;text-decoration:underline">App\HttpControllers</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">use</span><span style="color:#F8F8F2"> App\Http\Controllers\</span><span style="color:#66D9EF;font-style:italic">Controller</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F92672">use</span><span style="color:#F8F8F2"> AppModels\</span><span style="color:#66D9EF;font-style:italic">Siwe</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F92672">use</span><span style="color:#F8F8F2"> AppModels\</span><span style="color:#66D9EF;font-style:italic">User</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F92672">use</span><span style="color:#F8F8F2"> Ethereum\</span><span style="color:#66D9EF;font-style:italic">EcRecover</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F92672">use</span><span style="color:#F8F8F2"> Illuminate\Http\</span><span style="color:#66D9EF;font-style:italic">Request</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F92672">use</span><span style="color:#66D9EF;font-style:italic"> Str</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline">SiweController</span><span style="color:#F92672"> extends</span><span> </span><span style="color:#A6E22E;font-style:italic;text-decoration:underline">Controller</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#F92672">  public</span><span style="color:#66D9EF;font-style:italic"> function</span><span style="color:#A6E22E"> nonce</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">  {</span></span>
<span class="line"><span style="color:#F8F8F2">    $siwe </span><span style="color:#F92672">=</span><span style="color:#66D9EF;font-style:italic"> Siwe</span><span style="color:#F92672">::</span><span style="color:#A6E22E">create</span><span style="color:#F8F8F2">([</span></span>
<span class="line"><span style="color:#E6DB74">        'nonce'</span><span style="color:#F92672"> =></span><span style="color:#66D9EF;font-style:italic"> Str</span><span style="color:#F92672">::</span><span style="color:#A6E22E">random</span><span style="color:#F8F8F2">(</span><span style="color:#AE81FF">32</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#E6DB74">        'expires_at'</span><span style="color:#F92672"> =></span><span style="color:#A6E22E"> now</span><span style="color:#F8F8F2">()</span><span style="color:#F92672">-></span><span style="color:#A6E22E">addMinutes</span><span style="color:#F8F8F2">(</span><span style="color:#AE81FF">5</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    ]);</span></span>
<span class="line"><span style="color:#F92672">    return</span><span style="color:#A6E22E"> response</span><span style="color:#F8F8F2">()</span><span style="color:#F92672">-></span><span style="color:#A6E22E">json</span><span style="color:#F8F8F2">([</span><span style="color:#E6DB74">'nonce'</span><span style="color:#F92672"> =></span><span style="color:#F8F8F2"> $siwe</span><span style="color:#F92672">-></span><span style="color:#F8F8F2">nonce]);</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">  public</span><span style="color:#66D9EF;font-style:italic"> function</span><span style="color:#A6E22E"> verify</span><span style="color:#F8F8F2">(</span><span style="color:#66D9EF;font-style:italic">Request</span><span style="color:#F8F8F2"> $request)</span></span>
<span class="line"><span style="color:#F8F8F2">  {</span></span>
<span class="line"><span style="color:#F8F8F2">    $request</span><span style="color:#F92672">-></span><span style="color:#A6E22E">validate</span><span style="color:#F8F8F2">([</span></span>
<span class="line"><span style="color:#E6DB74">      'message'</span><span style="color:#F92672"> =></span><span style="color:#F8F8F2"> [</span><span style="color:#E6DB74">'required'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'string'</span><span style="color:#F8F8F2">],</span></span>
<span class="line"><span style="color:#E6DB74">      'signature'</span><span style="color:#F92672"> =></span><span style="color:#F8F8F2"> [</span><span style="color:#E6DB74">'required'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'string'</span><span style="color:#F8F8F2">], </span></span>
<span class="line"><span style="color:#E6DB74">      'wallet_address'</span><span style="color:#F92672"> =></span><span style="color:#F8F8F2"> [</span><span style="color:#E6DB74">'required'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'string'</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#F8F8F2">    ]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    $message </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> $request</span><span style="color:#F92672">-></span><span style="color:#F8F8F2">message;</span></span>
<span class="line"><span style="color:#F8F8F2">    $walletAddress </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> $request</span><span style="color:#F92672">-></span><span style="color:#F8F8F2">wallet_address;</span></span>
<span class="line"><span style="color:#F8F8F2">    $nonce </span><span style="color:#F92672">=</span><span style="color:#FD971F"> $this</span><span style="color:#F92672">-></span><span style="color:#A6E22E">extractNonceFromMessage</span><span style="color:#F8F8F2">($message);</span></span>
<span class="line"><span style="color:#F8F8F2">    $siwe </span><span style="color:#F92672">=</span><span style="color:#66D9EF;font-style:italic"> Siwe</span><span style="color:#F92672">::</span><span style="color:#A6E22E">where</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'nonce'</span><span style="color:#F8F8F2">, $nonce)</span><span style="color:#F92672">-></span><span style="color:#A6E22E">where</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'expires_at'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'>'</span><span style="color:#F8F8F2">, </span><span style="color:#A6E22E">now</span><span style="color:#F8F8F2">())</span><span style="color:#F92672">-></span><span style="color:#A6E22E">first</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F92672">    if</span><span style="color:#F8F8F2"> ($siwe </span><span style="color:#F92672">===</span><span style="color:#AE81FF"> null</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F92672">        return</span><span style="color:#A6E22E"> response</span><span style="color:#F8F8F2">()</span><span style="color:#F92672">-></span><span style="color:#A6E22E">json</span><span style="color:#F8F8F2">([</span></span>
<span class="line"><span style="color:#E6DB74">          'is_valid'</span><span style="color:#F92672"> =></span><span style="color:#AE81FF"> false</span><span style="color:#F8F8F2">, </span></span>
<span class="line"><span style="color:#E6DB74">          'error'</span><span style="color:#F92672"> =></span><span style="color:#E6DB74"> 'Invalid or expired nonce.'</span></span>
<span class="line"><span style="color:#F8F8F2">        ], </span><span style="color:#AE81FF">401</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">    $siwe</span><span style="color:#F92672">-></span><span style="color:#A6E22E">delete</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">    $verified </span><span style="color:#F92672">=</span><span style="color:#66D9EF;font-style:italic"> EcRecover</span><span style="color:#F92672">::</span><span style="color:#A6E22E">personalVerifyEcRecover</span><span style="color:#F8F8F2">($message, $request</span><span style="color:#F92672">-></span><span style="color:#F8F8F2">signature, </span><span style="color:#66D9EF">strtolower</span><span style="color:#F8F8F2">($walletAddress));</span></span>
<span class="line"><span style="color:#F92672">    if</span><span style="color:#F8F8F2"> ($verified) {</span></span>
<span class="line"><span style="color:#F8F8F2">        $user </span><span style="color:#F92672">=</span><span style="color:#66D9EF;font-style:italic"> User</span><span style="color:#F92672">::</span><span style="color:#A6E22E">firstOrCreate</span><span style="color:#F8F8F2">([</span><span style="color:#E6DB74">'wallet_address'</span><span style="color:#F92672"> =></span><span style="color:#F8F8F2"> $walletAddress]);</span></span>
<span class="line"><span style="color:#F8F8F2">        $token </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> $user</span><span style="color:#F92672">-></span><span style="color:#A6E22E">createToken</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'auth_token'</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F92672">        return</span><span style="color:#A6E22E"> response</span><span style="color:#F8F8F2">()</span><span style="color:#F92672">-></span><span style="color:#A6E22E">json</span><span style="color:#F8F8F2">([</span></span>
<span class="line"><span style="color:#E6DB74">            'is_valid'</span><span style="color:#F92672"> =></span><span style="color:#AE81FF"> true</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#E6DB74">            'token'</span><span style="color:#F92672"> =></span><span style="color:#F8F8F2"> $token</span><span style="color:#F92672">-></span><span style="color:#F8F8F2">plainTextToken,</span></span>
<span class="line"><span style="color:#F8F8F2">        ]);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F92672">    return</span><span style="color:#A6E22E"> response</span><span style="color:#F8F8F2">()</span><span style="color:#F92672">-></span><span style="color:#A6E22E">json</span><span style="color:#F8F8F2">([</span></span>
<span class="line"><span style="color:#E6DB74">      'is_valid'</span><span style="color:#F92672"> =></span><span style="color:#AE81FF"> false</span><span style="color:#F8F8F2">, </span></span>
<span class="line"><span style="color:#E6DB74">      'error'</span><span style="color:#F92672"> =></span><span style="color:#E6DB74"> 'Invalid signature'</span></span>
<span class="line"><span style="color:#F8F8F2">    ], </span><span style="color:#AE81FF">401</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">  private</span><span style="color:#66D9EF;font-style:italic"> function</span><span style="color:#A6E22E"> extractNonceFromMessage</span><span style="color:#F8F8F2">($message)</span></span>
<span class="line"><span style="color:#F8F8F2">  {</span></span>
<span class="line"><span style="color:#66D9EF">    preg_match</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'/Nonce: (w</span><span style="color:#F92672">+</span><span style="color:#E6DB74">)/'</span><span style="color:#F8F8F2">, $message, $matches);</span></span>
<span class="line"><span style="color:#F92672">    return</span><span style="color:#F8F8F2"> $matches[</span><span style="color:#AE81FF">1</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">??</span><span style="color:#AE81FF"> null</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre></div></div><p class="text-lg/relaxed text-neutral-700"> Nonce is a unique, one-time code that prevents replay attacks. Each login gets a fresh nonce that expires in 5 minutes and can&#39;t be reused. </p><p class="text-lg/relaxed text-neutral-700"> On frontend side prepare onClick onSignInWithMetamask function. </p><div class="relative text-sm"><button class="absolute right-2 top-2 bg-gray-600 text-white px-2 rounded-md cursor-pointer py-2 flex items-center justify-center h-8 w-8" aria-label="Copy code snippet to clipboard"><span class="material-icons-outlined !text-lg">content_copy</span></button><div class="p-4 bg-[#272822] rounded-md overflow-auto"><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2" tabindex="0"><code><span class="line"><span style="color:#F92672">import</span><span style="color:#F8F8F2"> { BrowserProvider, getAddress } </span><span style="color:#F92672">from</span><span style="color:#E6DB74"> "ethers"</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">const</span><span style="color:#A6E22E"> onSignInWithMetamask</span><span style="color:#F92672"> =</span><span style="color:#F92672"> async</span><span style="color:#F8F8F2"> () </span><span style="color:#66D9EF;font-style:italic">=></span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F92672">if</span><span style="color:#F8F8F2">(window.ethereum) {</span></span>
<span class="line"><span style="color:#F92672">  try</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    const</span><span style="color:#F8F8F2"> provider </span><span style="color:#F92672">=</span><span style="color:#F92672"> new</span><span style="color:#A6E22E"> BrowserProvider</span><span style="color:#F8F8F2">(window.ethereum);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    const</span><span style="color:#F8F8F2"> accounts </span><span style="color:#F92672">=</span><span style="color:#F92672"> await</span><span style="color:#F8F8F2"> provider.</span><span style="color:#A6E22E">send</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"eth_requestAccounts"</span><span style="color:#F8F8F2">, []);</span></span>
<span class="line"><span style="color:#F92672">    if</span><span style="color:#F8F8F2"> (accounts.length) {</span></span>
<span class="line"><span style="color:#A6E22E">      signSiwe</span><span style="color:#F8F8F2">(provider, accounts[</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">], _provider.info.name);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">  } </span><span style="color:#F92672">catch</span><span style="color:#F8F8F2"> (error) {</span></span>
<span class="line"><span style="color:#F8F8F2">    console.</span><span style="color:#A6E22E">error</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">'Sign-in failed: '</span><span style="color:#F92672"> +</span><span style="color:#F8F8F2"> error);</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">} </span><span style="color:#F92672">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#88846F">  // show message or redirect to Metamask install</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#F8F8F2">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">async</span><span style="color:#66D9EF;font-style:italic"> function</span><span style="color:#A6E22E"> getNonce</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">  const</span><span style="color:#F8F8F2"> res </span><span style="color:#F92672">=</span><span style="color:#F92672"> await</span><span style="color:#F8F8F2"> axios.</span><span style="color:#A6E22E">get</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"/api/auth/siwe/nonce"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F92672">  return</span><span style="color:#F8F8F2"> res.data.nonce;</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">async</span><span style="color:#66D9EF;font-style:italic"> function</span><span style="color:#A6E22E"> verifyMessage</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">message</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">signature</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">address</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">  const</span><span style="color:#F8F8F2"> response </span><span style="color:#F92672">=</span><span style="color:#F92672"> await</span><span style="color:#F8F8F2"> axios.</span><span style="color:#A6E22E">post</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"/api/auth/siwe/verify"</span><span style="color:#F8F8F2">, {</span></span>
<span class="line"><span style="color:#F8F8F2">    message,</span></span>
<span class="line"><span style="color:#F8F8F2">    signature,</span></span>
<span class="line"><span style="color:#F8F8F2">    wallet_address: address</span></span>
<span class="line"><span style="color:#F8F8F2">  });</span></span>
<span class="line"><span style="color:#F92672">  if</span><span style="color:#F8F8F2">(response.data.is_valid) {</span></span>
<span class="line"><span style="color:#88846F">    // user is logged in, store response.data.token</span></span>
<span class="line"><span style="color:#F8F8F2">  } </span><span style="color:#F92672">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#88846F">   // show error</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">const</span><span style="color:#A6E22E"> signSiwe</span><span style="color:#F92672"> =</span><span style="color:#F92672"> async</span><span style="color:#F8F8F2"> (</span><span style="color:#FD971F;font-style:italic">provider</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">baseAddress</span><span style="color:#F8F8F2">) </span><span style="color:#66D9EF;font-style:italic">=></span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">  const</span><span style="color:#F8F8F2"> address </span><span style="color:#F92672">=</span><span style="color:#A6E22E"> getAddress</span><span style="color:#F8F8F2">(baseAddress);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">  const</span><span style="color:#F8F8F2"> nonce </span><span style="color:#F92672">=</span><span style="color:#F92672"> await</span><span style="color:#A6E22E"> getNonce</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">  const</span><span style="color:#F8F8F2"> message </span><span style="color:#F92672">=</span><span style="color:#F92672"> new</span><span style="color:#A6E22E"> SiweMessage</span><span style="color:#F8F8F2">({</span></span>
<span class="line"><span style="color:#F8F8F2">    domain: location.host,</span></span>
<span class="line"><span style="color:#F8F8F2">    address: address,</span></span>
<span class="line"><span style="color:#F8F8F2">    statement: </span><span style="color:#E6DB74">"Please sign with your account"</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    uri: location.origin,</span></span>
<span class="line"><span style="color:#F8F8F2">    version: </span><span style="color:#E6DB74">"1"</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    chainId: </span><span style="color:#AE81FF">1</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    nonce: nonce,</span></span>
<span class="line"><span style="color:#F8F8F2">    issuedAt: </span><span style="color:#F92672">new</span><span style="color:#A6E22E"> Date</span><span style="color:#F8F8F2">().</span><span style="color:#A6E22E">toISOString</span><span style="color:#F8F8F2">(),</span></span>
<span class="line"><span style="color:#F8F8F2">  });</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">  const</span><span style="color:#F8F8F2"> preparedMessage </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> message.</span><span style="color:#A6E22E">prepareMessage</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">  const</span><span style="color:#F8F8F2"> signer </span><span style="color:#F92672">=</span><span style="color:#F92672"> await</span><span style="color:#F8F8F2"> provider.</span><span style="color:#A6E22E">getSigner</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">  const</span><span style="color:#F8F8F2"> signature </span><span style="color:#F92672">=</span><span style="color:#F92672"> await</span><span style="color:#F8F8F2"> signer.</span><span style="color:#A6E22E">signMessage</span><span style="color:#F8F8F2">(preparedMessage);</span></span>
<span class="line"><span style="color:#F92672">  await</span><span style="color:#A6E22E"> verifyMessage</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F8F8F2">    preparedMessage,</span></span>
<span class="line"><span style="color:#F8F8F2">    signature,</span></span>
<span class="line"><span style="color:#F8F8F2">    address,</span></span>
<span class="line"><span style="color:#F8F8F2">  );</span></span>
<span class="line"><span style="color:#F8F8F2">};</span></span>
<span class="line"></span></code></pre></div></div><p class="text-lg/relaxed text-neutral-700"> After verification user token could be saved and used in subsequent requests. </p><p class="text-lg/relaxed text-neutral-700">Useful links:</p><ul class="text-lg/relaxed text-neutral-700 list-disc ml-10 space-y-3 marker:text-gray-300"><li><a href="https://eips.ethereum.org/EIPS/eip-4361" rel="noopener noreferrer" target="_blank" class="link-primary">EIP-4361 specification</a></li></ul></div></article><nav class="max-w-3xl mx-auto mt-12"><a href="/" class="inline-block text-white py-2 px-4 bg-gradient-brand text-center shadow"> Back to list </a><button class="fixed right-4 bottom-4 w-12 h-12 rounded-full bg-gradient-brand text-white flex items-center justify-center shadow-lg z-50 cursor-pointer" aria-label="Back to top"><span class="material-icons-outlined">expand_less</span></button></nav></div></div></div><div id="teleports"></div><script type="application/json" data-nuxt-data="nuxt-app" data-ssr="true" id="__NUXT_DATA__" data-src="/how-to-implement-siwe/_payload.json?0fc9bcfb-d588-4046-8f0a-fcc4ef694756">[{"state":1,"once":3,"_errors":4,"serverRendered":6,"path":7,"prerenderedAt":8},["Reactive",2],{},["Set"],["ShallowReactive",5],{},true,"/how-to-implement-siwe",1761589649597]</script><script>window.__NUXT__={};window.__NUXT__.config={public:{},app:{baseURL:"/",buildId:"0fc9bcfb-d588-4046-8f0a-fcc4ef694756",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script></body></html>